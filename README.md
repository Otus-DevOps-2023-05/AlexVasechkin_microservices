# Итоговый проект
## Тема проекта
Тема проекта: Построение процесса непрервыной интеграции и мониторинга php приложения

## Введение
Проект представляет из себя Symfony приложение для отправки email сообщения через форму на главной странице. При отправке формы создается задание в брокере сообщений, после чего consumer выполняет отправку письма на указанный адрес через прописанный в env почтовый аккаунт.

## Инфраструктура:
Приложение размещено в пространстве Yandex Cloud на одной виртуальной машине.
Посредством Packer + Ansible playbook собирается базовый образ на основе Ubuntu 20.04. На него установлен Docker с помощью кастомной роли docker.

Посредством terraform выполняется создание виртуальной машины.

## Состав приложения
Приложение состоит из 4 (четырех) основных сервисов:
1. Сервис app - backend + frontend, он же producer;
2. Сервис consumer - контейнер выполнения задач очередей;
3. Сервис rabbitmq - брокер очередей;
4. Сервис redis - сервис кэша для хранения метрик от приложения.

## Организация процесса сборки и доставки
Все репозитории размещаются в сервисе Gitlab в проектной группе по [ссылке](https://gitlab.com/otus-devops-project-2023).
Каждый сервис имеет отдельный репозиторий с Dockerfile-ом и .gitlab-ci.yml, содержащий описание процесса CI/CD.

На уровне группы определены:
1. Параметры доступа в хранилище docker образов. В данном случае hub.docker.com;
2. Параметры доступа к виртуальной машине.

На уровне каждого репозитория определены:
1. DEPLOY_TOKEN;
2. другие частные параметры, необходимые для работы приложения.

Этап build включает сборку контейнера с помощью Docker-in-Docker.
 - Клонируется репозиторий;
 - Собирается docker образ;
 - Пушится в docker hub.
Этап deploy включает подтягивание свежего образа из docker registry и перезапуск контейнера по ssh.

Деплой преиложения включает промежуточный этап init, на котором init_job пересоздает конфигурационный файл из Gitlab Reposiry Variables на целевой машине.

## Сбор метрик
Точкой сбора метрик является Prometheus. Сервис собирает метрики от node-exporter, app и RabbitMQ.
Задачи по сбору описаны в конфигурационном файле. Сервис собран как Docker контейнер на базе общедоступного образа.

За производство метрик в приложении отвечает symfony bundle ArtprimaPrometheusMetricsBundle.
Приложение отдает метрики по маршруту http://app:80/metrics/prometheus

## Панель мониторинга
За визуализацию метрик отвечает сервис Grafana.
После развертывания приложения настроен Dashboard с оф. сайта Node Exporter Full по [ссылке](https://grafana.com/grafana/dashboards/1860-node-exporter-full/)

## Доступные сервисы
Приложение:
http://158.160.53.252:80

Cервис Prometheus:
http://158.160.53.252:9090

Панель Grafana:
http://158.160.53.252:3000
admin
1c9e201f

Панель RabbitMQ:
http://158.160.53.252:15672
admin
1c9e201f
